

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Edit Stack | Admin</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link rel="stylesheet" href="../bootstrap.css">

  <style>
    body {
      background-color: #0d1117;
      font-family: 'Lato';
      color: #fff;
    }

    @font-face {
      font-family: 'Lato';
      src: url(../fonts/Lato/Lato-Regular.ttf);
    }

    .edit-container {
      max-width: 600px;
      margin: 100px auto;
      background: #161b22;
      border-radius: 12px;
      padding: 35px;
      border: 1px solid #30363d;
      box-shadow: 0 0 25px rgba(0, 156, 255, 0.1);
    }

    h3 { color: #58a6ff; }

    .form-control {
      background-color: #0d1117;
      border: 1px solid #30363d;
      color: #fff;
    }

    .form-control:focus {
      border-color: #58a6ff;
      box-shadow: 0 0 8px rgba(88, 166, 255, 0.4);
    }

    .btn-primary {
      background-color: #238636;
      border: none;
    }

    .btn-secondary {
      background-color: #30363d;
      border: none;
    }

    .icon-preview {
      width: 60px;
      height: 60px;
      object-fit: contain;
      margin-bottom: 10px;
    }
  </style>
</head>

<body>

<div class="edit-container">
  <h3 class="text-center mb-4">
    <i class="bi bi-pencil-square me-2"></i>Edit Stack
  </h3>

  <form id="editStackForm">

    <div class="mb-3">
      <label class="form-label">Stack Name</label>
      <input type="text" id="name" class="form-control" required>
    </div>

    <div class="mb-3">
      <label class="form-label">Percentage</label>
      <input type="number" id="percentage" class="form-control" min="1" max="100" required>
    </div>

    <div class="mb-3">
      <label class="form-label">Order</label>
      <input type="number" id="order" class="form-control" required>
    </div>

    <div class="mb-3">
      <label class="form-label">Current Icon</label><br>
      <img id="iconPreview" class="icon-preview">
    </div>

    <div class="mb-4">
      <label class="form-label">Replace Icon (optional)</label>
      <input type="file" id="iconFile" class="form-control" accept="image/*">
    </div>

    <div class="d-flex justify-content-between">
      <a href="stack_management.html" class="btn btn-secondary">
        <i class="bi bi-arrow-left me-1"></i>Cancel
      </a>

      <button type="submit" class="btn btn-primary">
        <i class="bi bi-check-circle me-1"></i>Update
      </button>
    </div>

  </form>
</div>

<!-- Firebase -->
<script type="module">
import { doc, getDoc, updateDoc } from
  "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

import { db } from "../js/firebase-config.js";

/* ===============================
   CLOUDINARY
================================ */
const CLOUD_NAME = "djtjixlhw";
const UPLOAD_PRESET = "portfolio_unsigned";

async function uploadToCloudinary(file) {
  const formData = new FormData();
  formData.append("file", file);
  formData.append("upload_preset", UPLOAD_PRESET);

  const res = await fetch(
    `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`,
    { method: "POST", body: formData }
  );

  const data = await res.json();

  if (!res.ok) throw new Error("Cloudinary upload failed");

  return data.secure_url;
}

/* ===============================
   GET STACK ID
================================ */
const params = new URLSearchParams(window.location.search);
const stackId = params.get("id");

if (!stackId) {
  alert("Invalid stack ID");
  window.location.href = "stack_management.html";
}

/* ===============================
   ELEMENTS
================================ */
const form = document.getElementById("editStackForm");
const nameInput = document.getElementById("name");
const percentageInput = document.getElementById("percentage");
const orderInput = document.getElementById("order");
const iconPreview = document.getElementById("iconPreview");
const iconFile = document.getElementById("iconFile");

/* ===============================
   LOAD STACK DATA
================================ */
const stackRef = doc(db, "stacks", stackId);
const snap = await getDoc(stackRef);

if (!snap.exists()) {
  alert("Stack not found");
  window.location.href = "stack_management.html";
}

const stack = snap.data();

nameInput.value = stack.name;
percentageInput.value = stack.percentage;
orderInput.value = stack.order;
iconPreview.src = stack.icon;

/* ===============================
   UPDATE STACK
================================ */
form.addEventListener("submit", async (e) => {
  e.preventDefault();

  let iconUrl = stack.icon;

  if (iconFile.files.length > 0) {
    iconUrl = await uploadToCloudinary(iconFile.files[0]);
  }

  await updateDoc(stackRef, {
    name: nameInput.value.trim(),
    percentage: Number(percentageInput.value),
    order: Number(orderInput.value),
    icon: iconUrl
  });

  alert("âœ… Stack updated successfully");
  window.location.href = "stack_management.html";
});
</script>

</body>
</html>
